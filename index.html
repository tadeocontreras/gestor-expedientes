<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gestor de Expedientes (Multiusuario)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --radius: 12px; }

    /* --- Layout y tablas --- */
    .card{ border:1px solid #e5e7eb; border-radius:var(--radius); padding:12px; background:#fff }
    .grid{ display:grid; gap:12px }
    @media(min-width:900px){ .grid-3{grid-template-columns:repeat(3,1fr)} .grid-2{grid-template-columns:repeat(2,1fr)} }
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:8px; border-top:1px solid #e5e7eb; vertical-align: top }
    thead th{ background:#f6f7f9; position:sticky; top:0 }
    .chips{ display:flex; gap:6px; flex-wrap:wrap }
    .chip{ background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:2px 8px; font-size:12px }
    .muted{ color:#555; white-space:pre-wrap }
    .nowrap{ white-space:nowrap }

    /* --- Header por debajo del modal --- */
    header.card{ z-index: 10 !important; position: sticky; top: 0 }

    /* --- Modal estable (no tapa clics cuando est√° cerrado) --- */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; padding:12px; z-index:2000 }
    .modal-backdrop.is-open{ display:flex }
    .modal{ background:#fff; border-radius:var(--radius); border:1px solid #e5e7eb; max-width:920px; width:100%; max-height:90vh; overflow:auto; position:relative; z-index:2001 }

    /* Evitar que el fondo se mueva cuando el modal est√° abierto */
    body.modal-open { overflow: hidden; }

    /* Si el modal est√° oculto, que no capture clics */
    .modal-backdrop:not(.is-open){ pointer-events:none }
  </style>
</head>
<body>
  <header class="card">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <strong style="font-size:18px">Gestor de Expedientes</strong>
      <span style="color:#6b7280">Multiusuario (Supabase)</span>
      <span style="flex:1"></span>
      <button id="btn-nuevo">‚ûï Nuevo</button>
      <button id="btn-export">‚¨áÔ∏è Exportar CSV</button>
      <button id="btn-reset">üßπ Limpiar filtros</button>
    </div>
  </header>

  <main class="grid" style="margin-top:12px">
    <section class="grid grid-3">
      <div class="card">
        <div class="muted">Total de expedientes</div>
        <div id="kpi-total" style="font-size:28px; font-weight:700">0</div>
      </div>
      <div class="card">
        <div class="muted">Por tipo de juicio</div>
        <div id="rep-tipo" class="chips"></div>
      </div>
      <div class="card">
        <div class="muted">Por estado</div>
        <div id="rep-estado" class="chips"></div>
      </div>
    </section>

    <section class="card">
      <details open>
        <summary><strong>Filtros de b√∫squeda</strong></summary>
        <div class="grid grid-3" style="margin-top:8px">
          <div>
            <label>Buscar texto</label>
            <input id="f-q" placeholder="N¬∫, actor, demandado, juzgado‚Ä¶"/>
          </div>
          <div>
            <label>Tipo de juicio</label>
            <input id="f-tipo" placeholder="Civil, Familiar, Mercantil‚Ä¶"/>
          </div>
          <div class="grid grid-2">
            <div>
              <label>Desde (√ölt. acuerdo)</label>
              <input type="date" id="f-desde"/>
            </div>
            <div>
              <label>Hasta</label>
              <input type="date" id="f-hasta"/>
            </div>
          </div>
          <div>
            <label>Municipio</label>
            <input id="f-municipio"/>
          </div>
          <div>
            <label>Estado</label>
            <input id="f-estado"/>
          </div>
        </div>
      </details>
    </section>

    <section class="card" style="padding:0; overflow:auto">
      <table>
        <thead>
          <tr>
            <th class="nowrap">N¬∫ expediente</th>
            <th>Tipo</th>
            <th>Actor</th>
            <th>Demandado</th>
            <th>Juzgado</th>
            <th>Municipio / Estado</th>
            <th class="nowrap">√ölt. acuerdo</th>
            <th style="text-align:right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="muted" style="padding:14px; display:none">Sin registros. Crea el primero con ¬´Nuevo¬ª.</div>
    </section>
  </main>

  <!-- MODAL: Form -->
  <div class="modal-backdrop" id="modal-form">
    <div class="modal">
      <header>
        <strong id="form-title">Nuevo expediente</strong>
        <span style="flex:1"></span>
        <button onclick="UI.closeForm()">‚úñ</button>
      </header>
      <div class="body">
        <form id="form-exp" class="grid grid-2">
          <input type="hidden" id="id"/>
          <div><label>N¬∫ expediente *</label><input id="numero_expediente" required/></div>
          <div><label>Tipo de juicio *</label><input id="tipo_juicio" required/></div>
          <div><label>Fecha √∫ltimo acuerdo *</label><input type="date" id="fecha_ultimo_acuerdo" required/></div>
          <div><label>Circunscripci√≥n *</label><input id="circunscripcion" required/></div>
          <div><label>Juzgado - Nombre *</label><input id="juzgado_nombre" required/></div>
          <div><label>Juzgado - N√∫mero *</label><input id="juzgado_numero" required/></div>
          <div><label>Municipio *</label><input id="municipio" required/></div>
          <div><label>Estado *</label><input id="estado" required/></div>
          <div><label>Actor (nombre) *</label><input id="actor_nombre" required/></div>
          <div><label>Demandado (nombre) *</label><input id="demandado_nombre" required/></div>
          <div class="grid" style="grid-column:1/-1"><label>Situaci√≥n procesal *</label><textarea id="situacion_procesal" rows="3" required></textarea></div>
          <div class="grid" style="grid-column:1/-1"><label>Nota interna</label><textarea id="nota_interna" rows="2"></textarea></div>
          <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end">
            <button type="button" onclick="UI.closeForm()">Cancelar</button>
            <button>üíæ Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Detalle -->
  <div class="modal-backdrop" id="modal-detalle">
    <div class="modal">
      <header>
        <strong>Detalle del expediente</strong>
        <span style="flex:1"></span>
        <button onclick="UI.closeDetalle()">‚úñ</button>
      </header>
      <div class="body">
        <div id="det-head" class="chips" style="margin-bottom:8px"></div>
        <div id="det-resumen" class="grid grid-2"></div>
        <div class="card" style="margin-top:8px"><div class="muted">Situaci√≥n procesal</div><div id="det-situacion" class="muted"></div></div>
        <div class="card" style="margin-top:8px"><div class="muted">Nota interna</div><div id="det-nota" class="muted"></div></div>
        <details style="margin-top:8px">
          <summary><strong>Historial de actuaciones (oculto por defecto)</strong></summary>
          <div id="det-historial" class="grid" style="margin-top:8px"></div>
          <form id="form-act" class="grid grid-2" style="margin-top:8px">
            <div><label>Fecha *</label><input type="date" id="act-fecha" required/></div>
            <div><label>Descripci√≥n *</label><input id="act-desc" required/></div>
            <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:8px"><button>‚ûï Agregar actuaci√≥n</button></div>
          </form>
        </details>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px"><button id="btn-imprimir">üñ®Ô∏è Imprimir / PDF</button></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIGURACI√ìN SUPABASE ======
    // üîÅ REEMPLAZA con los tuyos desde Supabase ‚Üí Settings ‚Üí API
    const SUPABASE_URL = "https://klznqpzigtpmrhomzvnq.supabase.co";        // ej. https://xxxx.supabase.co
    const SUPABASE_ANON_KEY = "PON_AQUI_TU_ANON_KEY"; // ‚Üê pega tu anon key
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== Helpers ======
    function chip(txt){ const s=document.createElement('span'); s.className='chip'; s.textContent=txt; return s }
    function kv(k,v){ const d=document.createElement('div'); d.innerHTML=`<div class="muted">${escapeHtml(k)}</div><div><strong>${escapeHtml(v||'')}</strong></div>`; return d }
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[t])) }
    function toCSV(rows){ if(!rows.length) return ''; const headers=Object.keys(rows[0]); const head=headers.join(','); const body=rows.map(r=>headers.map(h=>csvEsc(r[h])).join(',')).join('\n'); return head+'\n'+body; function csvEsc(v){ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)? '"'+s.replaceAll('"','""')+'"': s } }

    // ====== Estado UI ======
    const UI = {
      filtros: { q:'', tipo:'', desde:'', hasta:'', municipio:'', estado:'' },
      datos: [],

      async init(){
        document.getElementById('btn-nuevo').onclick = ()=> UI.openForm();
        document.getElementById('btn-export').onclick = ()=> Export.csv();
        document.getElementById('btn-reset').onclick = ()=> { UI.filtros = { q:'', tipo:'', desde:'', hasta:'', municipio:'', estado:'' }; UI.syncFiltros(); UI.load(); };
        ['f-q','f-tipo','f-desde','f-hasta','f-municipio','f-estado'].forEach(id=> document.getElementById(id).addEventListener('input', UI.onFiltroChange));
        UI.syncFiltros();
        await UI.load();
      },

      onFiltroChange(){
        UI.filtros.q = document.getElementById('f-q').value.trim();
        UI.filtros.tipo = document.getElementById('f-tipo').value.trim();
        UI.filtros.desde = document.getElementById('f-desde').value;
        UI.filtros.hasta = document.getElementById('f-hasta').value;
        UI.filtros.municipio = document.getElementById('f-municipio').value.trim();
        UI.filtros.estado = document.getElementById('f-estado').value.trim();
        UI.load();
      },

      syncFiltros(){ const f=UI.filtros; document.getElementById('f-q').value=f.q; document.getElementById('f-tipo').value=f.tipo; document.getElementById('f-desde').value=f.desde; document.getElementById('f-hasta').value=f.hasta; document.getElementById('f-municipio').value=f.municipio; document.getElementById('f-estado').value=f.estado; },

      async load(){
        let query = sb.from('expedientes').select('*').order('fecha_ultimo_acuerdo', { ascending: false });
        const f = UI.filtros;
        if (f.tipo) query = query.ilike('tipo_juicio', `%${f.tipo}%`);
        if (f.municipio) query = query.ilike('municipio', `%${f.municipio}%`);
        if (f.estado) query = query.ilike('estado', `%${f.estado}%`);
        if (f.desde) query = query.gte('fecha_ultimo_acuerdo', f.desde);
        if (f.hasta) query = query.lte('fecha_ultimo_acuerdo', f.hasta);
        if (f.q) {
          const q = f.q.replace(/,/g,'');
          query = query.or(`numero_expediente.ilike.%${q}%,actor_nombre.ilike.%${q}%,demandado_nombre.ilike.%${q}%,juzgado_nombre.ilike.%${q}%,juzgado_numero.ilike.%${q}%,circunscripcion.ilike.%${q}%,tipo_juicio.ilike.%${q}%`);
        }
        const { data, error } = await query;
        if (error) { console.error(error); alert('Error cargando datos: '+ (error.message||'')); return }
        UI.datos = data || [];
        UI.render();
      },

      render(){
        const tbody = document.getElementById('tbody');
        const empty = document.getElementById('empty');
        tbody.innerHTML = '';
        if(UI.datos.length===0){ empty.style.display='block'; } else { empty.style.display='none'; }
        UI.datos.forEach(e => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="nowrap"><strong>${escapeHtml(e.numero_expediente)}</strong></td>
            <td>${escapeHtml(e.tipo_juicio)}</td>
            <td>${escapeHtml(e.actor_nombre)}</td>
            <td>${escapeHtml(e.demandado_nombre)}</td>
            <td>${escapeHtml(e.juzgado_nombre)} / ${escapeHtml(e.juzgado_numero)}</td>
            <td>${escapeHtml(e.municipio)} / ${escapeHtml(e.estado)}</td>
            <td class="nowrap">${escapeHtml(e.fecha_ultimo_acuerdo)}</td>
            <td style="text-align:right">
              <button onclick="UI.ver('${e.id}')">üëÅÔ∏è Ver</button>
              <button onclick="UI.editar('${e.id}')">‚úèÔ∏è Editar</button>
              <button onclick="Print.expediente('${e.id}')">üñ®Ô∏è PDF</button>
              <button onclick="UI.eliminar('${e.id}')">üóëÔ∏è Eliminar</button>
            </td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('kpi-total').textContent = String(UI.datos.length);
        Reports.render(UI.datos);
      },

      async eliminar(id){
        if(!confirm('¬øEliminar expediente?')) return;
        const { error } = await sb.from('expedientes').delete().eq('id', id);
        if (error) { alert('Error al eliminar: '+(error.message||'')); console.error(error); return }
        await UI.load();
      },

      // ----- Form -----
      openForm(initial){
        document.getElementById('modal-form').classList.add('is-open');
        document.body.classList.add('modal-open');
        document.getElementById('form-title').textContent = initial? 'Editar expediente' : 'Nuevo expediente';

        const d = initial || { id:'', numero_expediente:'', tipo_juicio:'', fecha_ultimo_acuerdo:new Date().toISOString().slice(0,10), situacion_procesal:'', juzgado_nombre:'', juzgado_numero:'', circunscripcion:'', municipio:'', estado:'', actor_nombre:'', demandado_nombre:'', nota_interna:'' };
        for (const k of ['id','numero_expediente','tipo_juicio','fecha_ultimo_acuerdo','situacion_procesal','juzgado_nombre','juzgado_numero','circunscripcion','municipio','estado','actor_nombre','demandado_nombre','nota_interna']){ document.getElementById(k).value = d[k] || ''; }

        const form = document.getElementById('form-exp');
        form.onsubmit = async (ev)=>{
          ev.preventDefault();
          const data = {}; 
          for (const k of ['numero_expediente','tipo_juicio','fecha_ultimo_acuerdo','situacion_procesal','juzgado_nombre','juzgado_numero','circunscripcion','municipio','estado','actor_nombre','demandado_nombre','nota_interna']){ 
            data[k] = document.getElementById(k).value.trim(); 
          }
          for (const req of ['numero_expediente','tipo_juicio','fecha_ultimo_acuerdo','circunscripcion','juzgado_nombre','juzgado_numero','municipio','estado','actor_nombre','demandado_nombre','situacion_procesal']){ if(!data[req]) return alert('Falta: '+req.replace('_',' ')); }
          const idVal = document.getElementById('id').value.trim();
          let res;
          if (idVal) {
            res = await sb.from('expedientes').update(data).eq('id', idVal).select('*').single();
          } else {
            res = await sb.from('expedientes').insert(data).select('*').single();
          }
          if (res.error) { console.error(res.error); alert('Error: '+(res.error.message||'al guardar')); return }
          UI.closeForm(); await UI.load();
        };
      },
      closeForm(){ document.getElementById('modal-form').classList.remove('is-open'); document.body.classList.remove('modal-open'); },

      editar(id){ const rec = UI.datos.find(x=>x.id===id); if(rec) UI.openForm(rec); },

      async ver(id){
        const { data: e, error } = await sb.from('expedientes').select('*').eq('id', id).single();
        if (error || !e) { alert('No encontrado'); return }
        const head = document.getElementById('det-head'); head.innerHTML='';
        head.append(chip('N¬∫ '+e.numero_expediente)); head.append(chip('Tipo: '+e.tipo_juicio)); head.append(chip(e.municipio+' / '+e.estado)); head.append(chip('√ölt. acuerdo: '+e.fecha_ultimo_acuerdo));
        const res = document.getElementById('det-resumen'); res.innerHTML='';
        res.append(kv('Actor', e.actor_nombre)); res.append(kv('Demandado', e.demandado_nombre)); res.append(kv('Juzgado', e.juzgado_nombre+' / '+e.juzgado_numero)); res.append(kv('Circunscripci√≥n', e.circunscripcion));
        document.getElementById('det-situacion').textContent = e.situacion_procesal || '';
        document.getElementById('det-nota').textContent = e.nota_interna || '';

        const hist = document.getElementById('det-historial'); hist.innerHTML='';
        const { data: acts } = await sb.from('actuaciones_historial').select('*').eq('expediente_id', id).order('fecha', { ascending: false });
        (acts||[]).forEach(a=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML = `<div class=muted><strong>${escapeHtml(a.fecha)}</strong> ‚Äî ${escapeHtml(a.descripcion)}</div>`; hist.append(c); });

        const formAct = document.getElementById('form-act');
        formAct.onsubmit = async (ev)=>{
          ev.preventDefault();
          const fecha = document.getElementById('act-fecha').value; const desc = document.getElementById('act-desc').value.trim();
          if(!fecha || !desc) return alert('Falta fecha o descripci√≥n');
          const { error } = await sb.from('actuaciones_historial').insert({ expediente_id: id, fecha, descripcion: desc });
          if (error) { alert('Error al agregar actuaci√≥n: '+(error.message||'')); console.error(error); return }
          document.getElementById('act-fecha').value=''; document.getElementById('act-desc').value='';
          UI.ver(id);
        };

        document.getElementById('btn-imprimir').onclick = ()=> Print.expediente(id);
        document.getElementById('modal-detalle').classList.add('is-open');
        document.body.classList.add('modal-open');
      },
      closeDetalle(){ document.getElementById('modal-detalle').classList.remove('is-open'); document.body.classList.remove('modal-open'); }
    };

    // ====== Reportes ======
    const Reports = {
      render(list){
        const repTipo = document.getElementById('rep-tipo'); repTipo.innerHTML='';
        const byTipo = countBy(list, x=>x.tipo_juicio); Object.entries(byTipo).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=> repTipo.append(chip(`${k}: ${v}`))); if(!Object.keys(byTipo).length) repTipo.textContent='‚Äî';
        const repEdo = document.getElementById('rep-estado'); repEdo.innerHTML='';
        const byEdo = countBy(list, x=>x.estado); Object.entries(byEdo).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=> repEdo.append(chip(`${k}: ${v}`))); if(!Object.keys(byEdo).length) repEdo.textContent='‚Äî';
        function countBy(list, fn){ const m={}; list.forEach(x=>{ const k=fn(x)||'‚Äî'; m[k]=(m[k]||0)+1; }); return m }
      }
    };

    // ====== Export / Print ======
    const Export = {
      async csv(){
        const list = UI.datos; if(!list.length) return alert('No hay registros para exportar');
        const rows = list.map(e=>({ numero_expediente:e.numero_expediente, tipo_juicio:e.tipo_juicio, fecha_ultimo_acuerdo:e.fecha_ultimo_acuerdo, actor:e.actor_nombre, demandado:e.demandado_nombre, juzgado_nombre:e.juzgado_nombre, juzgado_numero:e.juzgado_numero, circunscripcion:e.circunscripcion, municipio:e.municipio, estado:e.estado, situacion_procesal:e.situacion_procesal, nota_interna:e.nota_interna||'' }));
        const csv = toCSV(rows); const blob = new Blob(['\uFEFF'+csv], { type:'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`expedientes_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
      }
    };

    const Print = {
      async expediente(id){
        const { data: e } = await sb.from('expedientes').select('*').eq('id', id).single(); if(!e) return;
        const w = window.open('', '_blank'); if(!w) return;
        const h = `<!doctype html><html lang=es><head><meta charset=utf-8><title>Expediente ${e.numero_expediente}</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto;padding:20px}h1{font-size:20px;margin:0 0 6px}.grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px}.box{border:1px solid #e5e7eb;padding:10px;border-radius:10px;margin-top:10px}.label{color:#555;font-size:12px}.val{font-weight:600}.muted{white-space:pre-wrap}</style></head><body>
          <h1>Expediente ${escapeHtml(e.numero_expediente)}</h1>
          <div class=grid>
            <div><div class=label>Tipo de juicio</div><div class=val>${escapeHtml(e.tipo_juicio)}</div></div>
            <div><div class=label>Fecha √∫ltimo acuerdo</div><div class=val>${escapeHtml(e.fecha_ultimo_acuerdo)}</div></div>
            <div><div class=label>Actor</div><div class=val>${escapeHtml(e.actor_nombre)}</div></div>
            <div><div class=label>Demandado</div><div class=val>${escapeHtml(e.demandado_nombre)}</div></div>
            <div><div class=label>Juzgado</div><div class=val>${escapeHtml(e.juzgado_nombre)} / ${escapeHtml(e.juzgado_numero)}</div></div>
            <div><div class=label>Circunscripci√≥n</div><div class=val>${escapeHtml(e.circunscripcion)}</div></div>
            <div><div class=label>Municipio</div><div class=val>${escapeHtml(e.municipio)}</div></div>
            <div><div class=label>Estado</div><div class=val>${escapeHtml(e.estado)}</div></div>
          </div>
          <div class=box><div class=label>Situaci√≥n procesal</div><div class=muted>${escapeHtml(e.situacion_procesal)}</div></div>
          ${e.nota_interna? `<div class=box><div class=label>Nota interna</div><div class=muted>${escapeHtml(e.nota_interna)}</div></div>`: ''}
        </body></html>`;
        w.document.write(h); w.document.close(); w.focus(); w.print();
      }
    };

    // Iniciar (el script est√° al final del body, DOM ya cargado)
    UI.init();
  </script>
</body>
</html>
